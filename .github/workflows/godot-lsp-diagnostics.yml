name: 'Godot LSP Diagnostics (PR)'

on:
  pull_request:
    paths:
      - '**/*.tres'
      - '.vscode/**'
      - 'Godot/**'
      - '*.gd'
      - 'scripts/fix-godot-lsp.cjs'

jobs:
  lsp-diagnostics:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Run Godot LSP diagnostics
        run: |
          node scripts/fix-godot-lsp.cjs --ci-fail

      - name: Summarize Godot LSP diagnostics
        if: failure()
        run: |
          echo "::group::Godot LSP / Firewall remediation summary"
          echo "One or more Godot LSP / firewall policy checks failed."
          echo "Common fixes:"
          echo "  - Ensure Godot editor and VS Code Godot Tools share the same LSP port (per Policy.GodotLSPStandard_v1)."
          echo "  - Run the ALN test harness locally:" 
          echo "      pwsh -File .aln/run-tests.ps1"
          echo "    or"
          echo "      chmod +x .aln/run-tests.sh .aln/tools/validate-aln.sh && ./.aln/run-tests.sh"
          echo "  - Follow GODOT_LSP_OPS.md and GODOT_LSP_FIX.md to update project and IDE configs."
          echo "::endgroup::"
